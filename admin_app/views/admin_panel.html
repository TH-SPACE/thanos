<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ThanOS - Painel do Administrador</title>
    <link rel="icon" href="/img/b2b.png" />

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css    " rel="stylesheet" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css    " />

    <style>
        body {
            padding-top: 70px;
            background-color: #f8f9fa;
        }

        .navbar-brand img {
            margin-right: 8px;
        }

        .card-header {
            font-weight: 600;
        }

        .table th {
            background-color: #f1f3f5;
        }

        .search-container {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .search-container {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/admin">
                <img src="/img/base-de-dados.gif" width="30" height="30" class="rounded-circle" alt="Logo">
                <span>Admin Panel</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
                aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item" id="planejamentoHE">
                        <a class="nav-link" href="/planejamento-he">Planejamento HE</a>
                    </li>
                    <li class="nav-item" id="thanosApp">
                        <a class="nav-link" href="/thanos">ThanOS</a>
                    </li>
                </ul>

                <!-- Dropdown do Usuário -->
                <div class="dropdown">
                    <a class="nav-link dropdown-toggle text-white d-flex align-items-center" href="#"
                        id="usuarioDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-user-circle fa-lg me-2"></i>
                        <span id="nomeUsuario">Usuário</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="usuarioDropdown">
                        <li><a id="painelAdmBtn" class="dropdown-item" href="/admin" style="display: none;">
                                <i class="fas fa-cogs text-warning me-2"></i> PAINEL ADM
                            </a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item text-danger" href="/auth/logout">
                                <i class="fas fa-sign-out-alt me-2"></i> SAIR
                            </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Conteúdo Principal -->
    <div class="container-fluid px-4 py-3">
        <div class="d-flex align-items-center mb-4">
            <h2 class="text-primary mb-0">
                <i class="fas fa-user-shield me-2"></i>Painel do Administrador
            </h2>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-users me-2"></i>Lista de Usuários</span>
                <div class="search-container">
                    <input type="text" id="buscaUsuario" class="form-control form-control-sm"
                        placeholder="Buscar por nome ou e-mail" />
                    <button id="btnResetar" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-redo me-1"></i>Resetar
                    </button>
                    <button id="btnAdicionar" class="btn btn-success btn-sm" data-bs-toggle="modal"
                        data-bs-target="#modalAdicionar">
                        <i class="fas fa-plus me-1"></i>Adicionar Usuário
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>E-mail</th>
                                <th>Perfil</th>
                                <th>Cargo</th>
                                <th class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaUsuarios">
                            <!-- Conteúdo dinâmico via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edição -->
    <div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="formEditar">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalLabel"><i class="fas fa-edit me-2"></i>Editar Usuário</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editarId" />
                        <div class="mb-3">
                            <label class="form-label">Nome completo</label>
                            <input type="text" id="editarNome" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cargo</label>
                            <input type="text" id="editarCargo" class="form-control" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Perfis (selecione um ou mais)</label>
                            <div id="editarPerfil" class="d-flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Adicionar Usuário -->
    <div class="modal fade" id="modalAdicionar" tabindex="-1" aria-labelledby="modalAdicionarLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="formAdicionar">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalAdicionarLabel"><i class="fas fa-user-plus me-2"></i>Adicionar
                            Novo Usuário</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">E-mail do Usuário (do Active Directory)</label>
                            <input type="email" id="adicionarEmail" class="form-control" required />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Adicionar Usuário</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/sweetalert2.all.min.js"></script>
    <script src="  https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js    "></script>

    <script>
        // Carregar dados do usuário logado
        fetch('/auth/usuario')
            .then(res => res.json())
            .then(data => {
                const nomeUsuario = data.nome;
                const perfilUsuario = data.perfil;
                const acessos = data.acessos;

                document.getElementById('nomeUsuario').innerText = nomeUsuario;

                if (perfilUsuario.includes('ADM')) {
                    document.getElementById('painelAdmBtn').style.display = 'block';
                }
                if (perfilUsuario.includes('ADM') || perfilUsuario.includes('USER_UPLOAD')) {
                    document.getElementById('painelUpload').style.display = 'block';
                }
                /*
                if (acessos.includes('posbd')) {
                    document.getElementById('posBd').style.display = 'block';
                }
                */
                // Nota: 'relatorios' não está no HTML atual, então foi mantido comentado
                console.log('Acessos do usuário:', acessos);
            });

        // Função para renderizar usuários
        function renderUsuarios() {
            fetch('/admin/usuarios')
                .then(res => res.json())
                .then(usuarios => {
                    const tabela = document.getElementById('tabelaUsuarios');
                    tabela.innerHTML = '';

                    usuarios.forEach(user => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
              <td>${user.id}</td>
              <td>${user.nome}</td>
              <td>${user.email}</td>
              <td>${user.perfil}</td>
              <td>${user.cargo || ''}</td>
              <td class="text-center">
                <button class="btn btn-sm btn-warning me-1" onclick="abrirModalEditar(${user.id}, '${user.nome.replace(/'/g, "\\'")}', '${user.perfil}', '${(user.cargo || '').replace(/'/g, "\\'")}')">Editar</button>
                <button class="btn btn-sm btn-danger" onclick="alertaExcluir(${user.id}, '${user.nome.replace(/'/g, "\\'")}')">Excluir</button>
              </td>
            `;
                        tabela.appendChild(tr);
                    });
                })
                .catch(err => console.error('Erro ao carregar usuários:', err));
        }

        function abrirModalEditar(id, nome, perfil, cargo) {
            document.getElementById('editarId').value = id;
            document.getElementById('editarNome').value = nome;
            document.getElementById('editarCargo').value = cargo || '';

            const perfisDisponiveis = ['USER', 'ADM', 'HE_ENGENHARIA', 'HE_IMPLANTACAO', 'HE_APROVADOR', 'USER_UPLOAD'];
            const perfisUsuario = perfil.split(',').map(p => p.trim());
            const container = document.getElementById('editarPerfil');
            container.innerHTML = '';

            perfisDisponiveis.forEach(p => {
                const isChecked = perfisUsuario.includes(p);
                const div = document.createElement('div');
                div.classList.add('form-check');
                div.innerHTML = `
          <input class="form-check-input" type="checkbox" name="perfil" value="${p}" id="perfil_${p}" ${isChecked ? 'checked' : ''}>
          <label class="form-check-label" for="perfil_${p}">${p}</label>
        `;
                container.appendChild(div);
            });

            const modal = new bootstrap.Modal(document.getElementById('modalEditar'));
            modal.show();
        }

        document.getElementById('formEditar').addEventListener('submit', function (e) {
            e.preventDefault();

            const id = document.getElementById('editarId').value;
            const nome = document.getElementById('editarNome').value;
            const cargo = document.getElementById('editarCargo').value;
            const perfisSelecionados = Array.from(document.querySelectorAll('#editarPerfil input:checked')).map(cb => cb.value);
            const perfil = perfisSelecionados.join(',');

            const formData = new URLSearchParams();
            formData.append('id', id);
            formData.append('nome', nome);
            formData.append('cargo', cargo);
            formData.append('perfil', perfil);

            fetch(`/admin/editar/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            })
                .then(() => {
                    bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide();
                    renderUsuarios();
                })
                .catch(err => console.error('Erro ao editar:', err));
        });

        function alertaExcluir(id, nome) {
            Swal.fire({
                title: 'Tem certeza?',
                text: `Deseja realmente excluir o usuário "${nome}"?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/admin/excluir/${id}`, { method: 'POST' })
                        .then(() => {
                            Swal.fire('Excluído!', 'O usuário foi removido com sucesso.', 'success');
                            renderUsuarios();
                        })
                        .catch(() => {
                            Swal.fire('Erro!', 'Não foi possível excluir o usuário.', 'error');
                        });
                }
            });
        }

        document.getElementById('buscaUsuario').addEventListener('input', function () {
            const termo = this.value.toLowerCase();
            const linhas = document.querySelectorAll('#tabelaUsuarios tr');
            linhas.forEach(linha => {
                const nome = linha.children[1]?.textContent.toLowerCase() || '';
                const email = linha.children[2]?.textContent.toLowerCase() || '';
                linha.style.display = (nome.includes(termo) || email.includes(termo)) ? '' : 'none';
            });
        });

        document.getElementById('btnResetar').addEventListener('click', function () {
            document.getElementById('buscaUsuario').value = '';
            renderUsuarios();
        });

        document.addEventListener('DOMContentLoaded', renderUsuarios);

        // --- Adicionando manipuladores para o Modal de Adicionar ---

        const modalAdicionarElement = document.getElementById('modalAdicionar');
        const formAdicionar = document.getElementById('formAdicionar');

        // Manipulador para o botão "Cancelar" do modal de adicionar
        // Assumindo que o botão "Cancelar" tem a classe 'btn-secondary' dentro do footer do modal de adicionar
        // Pode ser necessário ajustar o seletor se houver mais de um botão .btn-secondary
        const botaoCancelarAdicionar = modalAdicionarElement.querySelector('.modal-footer .btn-secondary');
        if (botaoCancelarAdicionar) {
            botaoCancelarAdicionar.addEventListener('click', function () {
                // Opcional: Limpar o formulário ao cancelar
                formAdicionar.reset();
                // O data-bs-dismiss="modal" no botão deve fechar o modal, mas explicitamente garantir pode ser útil
                // const modalInstance = bootstrap.Modal.getInstance(modalAdicionarElement);
                // if (modalInstance) modalInstance.hide();
            });
        }

        // Manipulador para o botão "X" de fechar do modal de adicionar
        const botaoFecharAdicionar = modalAdicionarElement.querySelector('.modal-header .btn-close');
        if (botaoFecharAdicionar) {
            botaoFecharAdicionar.addEventListener('click', function () {
                // Opcional: Limpar o formulário ao fechar
                formAdicionar.reset();
                // O data-bs-dismiss="modal" no botão deve fechar o modal, mas explicitamente garantir pode ser útil
                // const modalInstance = bootstrap.Modal.getInstance(modalAdicionarElement);
                // if (modalInstance) modalInstance.hide();
            });
        }


        // Submissão do formulário de adicionar
        formAdicionar.addEventListener('submit', function (e) {
            e.preventDefault();

            const email = document.getElementById('adicionarEmail').value.trim(); // Adicionando trim()

            if (!email) { // Validação simples do lado do cliente
                Swal.fire('Erro!', 'Por favor, informe um e-mail válido.', 'error');
                return; // Sai da função se o e-mail estiver vazio
            }

            const formData = new URLSearchParams();
            formData.append('email', email);

            // Opcional: Mostrar um carregamento
            const btnSubmit = formAdicionar.querySelector('button[type="submit"]');
            btnSubmit.disabled = true;
            btnSubmit.textContent = 'Adicionando...'; // Muda o texto do botão

            fetch('/admin/adicionar_usuario', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        // Tenta ler o corpo da resposta para obter mensagem de erro
                        return response.text().then(text => { throw new Error(text || `HTTP error! status: ${response.status}`); });
                    }
                    return response.json(); // Tenta parsear JSON
                })
                .then(data => {
                    if (data && data.sucesso) { // Verifica se data existe e tem sucesso = true
                        // Limpa o formulário
                        formAdicionar.reset();
                        // Fecha o modal
                        bootstrap.Modal.getInstance(modalAdicionarElement).hide();
                        // Mostra mensagem de sucesso
                        Swal.fire('Sucesso!', data.mensagem || 'Usuário adicionado com sucesso!', 'success');
                        // Atualiza a lista de usuários
                        renderUsuarios();
                    } else {
                        // Trata resposta JSON com sucesso = false
                        Swal.fire('Erro!', data.erro || 'Erro desconhecido ao adicionar usuário.', 'error');
                    }
                })
                .catch(err => {
                    console.error('Erro ao adicionar usuário:', err);
                    // Trata erros de rede ou JSON inválido
                    Swal.fire('Erro!', 'Ocorreu um erro inesperado: ' + err.message, 'error');
                })
                .finally(() => {
                    // Reabilita o botão e restaura o texto, independentemente do resultado
                    btnSubmit.disabled = false;
                    btnSubmit.textContent = 'Adicionar Usuário';
                });
        });

        // --- Fim das alterações para o Modal de Adicionar ---

        // ... (resto do código existente) ...

        // Abrir modal de adicionar (este código pode ser mantido ou removido se o data-bs-toggle funcionar)
        // document.getElementById('btnAdicionar').addEventListener('click', () => {
        //     const modal = new bootstrap.Modal(modalAdicionarElement);
        //     modal.show();
        // });

    </script>
</body>

</html>